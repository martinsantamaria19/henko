---
import { blogPosts } from "../data/blog";

const blogPostsHome = blogPosts.slice(0, 3);
---

<section class="py-20 md:py-24 relative" id="blog">
    <div class="container-2xl mx-auto px-6 md:px-8 relative z-10">
        <div
            class="inline-block bg-[#161616] text-white pt-5 pb-6 pl-6 pr-10 md:pt-8 md:pb-10 md:pl-10 md:pr-32 rounded-br-[40px] md:rounded-br-[100px] mb-8 md:mb-12 shadow-2xl -ml-4 md:-ml-16 relative max-w-full"
        >
            <h2
                class="text-3xl md:text-6xl pl-0 md:pl-50 font-serif font-bold tracking-tight"
            >
                <a href="/blog" class="hover:opacity-90 transition-opacity">Nuestro blog</a>
            </h2>
        </div>
    </div>

    <div class="container mx-auto px-6 md:px-8 relative z-10">
        <div
            class="flex flex-col md:flex-row justify-between items-end gap-8 mb-16"
        >
            <p class="text-gray-500 max-w-2xl text-base leading-relaxed">
                Visitá nuestro blog y descubrí estrategias, análisis y tendencias de marketing digital y performance para empresas en Uruguay y la región.
            </p>

            <!-- En desktop: link al listado -->
            <div class="hidden md:block">
                <a
                    href="/blog"
                    class="inline-flex items-center gap-2 text-xs font-bold text-gray-400 hover:text-primary-dark tracking-widest transition-colors"
                >
                    Ver todos
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                    </svg>
                </a>
            </div>
        </div>

        <!-- Contenedor: en mobile carrusel con flechas, en desktop grid -->
        <div class="relative w-full">
            <button
                type="button"
                class="blog-carousel-prev absolute left-2 top-1/2 -translate-y-1/2 z-20 md:hidden w-12 h-12 rounded-full bg-white/90 shadow-lg border border-gray-200 flex items-center justify-center text-primary-dark hover:bg-white hover:scale-110 transition-all disabled:opacity-40 disabled:pointer-events-none disabled:scale-100"
                aria-label="Artículo anterior"
            >
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                </svg>
            </button>
            <button
                type="button"
                class="blog-carousel-next absolute right-2 top-1/2 -translate-y-1/2 z-20 md:hidden w-12 h-12 rounded-full bg-white/90 shadow-lg border border-gray-200 flex items-center justify-center text-primary-dark hover:bg-white hover:scale-110 transition-all disabled:opacity-40 disabled:pointer-events-none disabled:scale-100"
                aria-label="Siguiente artículo"
            >
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                </svg>
            </button>
            <div class="blog-carousel-wrapper w-full overflow-hidden md:overflow-visible">
            <div class="blog-carousel-track flex md:grid md:grid-cols-3 gap-8 w-full transition-transform duration-300 ease-out md:!translate-x-0">
            {blogPostsHome.map((post) => (
            <a
                href={`/blog/${post.slug}`}
                class="blog-carousel-slide flex-shrink-0 w-[var(--blog-slide-px,100%)] min-w-0 md:w-auto md:min-w-0 bg-white rounded-[32px] overflow-hidden shadow-sm hover:shadow-[0_20px_40px_-15px_rgba(0,0,0,0.1)] transition-all duration-300 group cursor-pointer h-full flex flex-col"
            >
                <div class="h-64 overflow-hidden relative">
                    <div
                        class="absolute inset-0 bg-black/10 group-hover:bg-transparent transition-colors z-10"
                    >
                    </div>
                    <img
                        src={post.image}
                        alt={post.imageAlt}
                        class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-700"
                    />
                </div>
                <div class="p-8 flex-1 flex flex-col">
                    <div
                        class="flex justify-between items-center text-xs text-gray-400 mb-4 font-medium uppercase tracking-wide"
                    >
                        <span>{post.category}</span>
                        <span>{post.date}</span>
                    </div>
                    <h3
                        class="font-bold text-xl text-[#1A1A1A] mb-3 leading-tight group-hover:text-primary-dark transition-colors"
                    >
                        {post.title}
                    </h3>
                    <p
                        class="text-sm text-gray-500 leading-relaxed line-clamp-3"
                    >
                        {post.excerpt}
                    </p>
                </div>
            </a>
            ))}
        </div>
            </div>
        </div>
        <div class="blog-carousel-dots flex md:hidden justify-center gap-2 mt-8" aria-label="Indicadores de slide">
            {blogPostsHome.map((_, i) => (
            <button type="button" class="blog-carousel-dot w-2.5 h-2.5 rounded-full bg-gray-300 hover:bg-primary-dark transition-colors aria-[current]:bg-primary-dark aria-[current]:scale-125" aria-label={`Slide ${i + 1}`} aria-current={i === 0 ? "true" : "false"} data-index={i}></button>
            ))}
        </div>
    </div>
</section>

<script>
  (function initBlogCarousel() {
    const wrapper = document.querySelector(".blog-carousel-wrapper") as HTMLElement | null;
    const track = document.querySelector(".blog-carousel-track") as HTMLElement | null;
    const prevBtn = document.querySelector(".blog-carousel-prev") as HTMLButtonElement | null;
    const nextBtn = document.querySelector(".blog-carousel-next") as HTMLButtonElement | null;
    const dots = document.querySelectorAll(".blog-carousel-dot");
    const slides = document.querySelectorAll(".blog-carousel-slide");
    if (!wrapper || !track || !slides.length) return;
    let index = 0;
    const total = slides.length;
    const gap = 32;
    const AUTOPLAY_INTERVAL_MS = 5000;
    let autoplayTimer: ReturnType<typeof setInterval> | null = null;
    function isMobile() { return window.matchMedia("(max-width: 767px)").matches; }
    function startAutoplay() {
      if (autoplayTimer) clearInterval(autoplayTimer);
      autoplayTimer = null;
      if (!isMobile()) return;
      autoplayTimer = setInterval(() => { goTo(index >= total - 1 ? 0 : index + 1); }, AUTOPLAY_INTERVAL_MS);
    }
    function stopAutoplay() {
      if (autoplayTimer) { clearInterval(autoplayTimer); autoplayTimer = null; }
    }
    function updateCarousel() {
      if (!wrapper || !track) return;
      const w = wrapper;
      const t = track;
      if (!isMobile()) {
        t.style.transform = "";
        w.style.removeProperty("--blog-slide-px");
        return;
      }
      const width = w.getBoundingClientRect().width;
      w.style.setProperty("--blog-slide-px", `${width}px`);
      t.style.transform = `translateX(-${index * (width + gap)}px)`;
    }
    function updateControls() {
      if (prevBtn) prevBtn.disabled = index <= 0;
      if (nextBtn) nextBtn.disabled = index >= total - 1;
      dots.forEach((d, i) => d.setAttribute("aria-current", i === index ? "true" : "false"));
    }
    function goTo(i: number) {
      index = Math.max(0, Math.min(i, total - 1));
      updateCarousel();
      updateControls();
      startAutoplay();
    }
    prevBtn?.addEventListener("click", () => goTo(index - 1));
    nextBtn?.addEventListener("click", () => goTo(index + 1));
    dots.forEach((d, i) => (d as HTMLElement).addEventListener("click", () => goTo(i)));
    window.addEventListener("resize", () => {
      if (!isMobile()) index = 0;
      if (!isMobile()) stopAutoplay(); else startAutoplay();
      updateCarousel();
      updateControls();
    });
    document.addEventListener("visibilitychange", () => {
      if (document.hidden) stopAutoplay(); else if (isMobile()) startAutoplay();
    });
    updateCarousel();
    updateControls();
    startAutoplay();
  })();
</script>
