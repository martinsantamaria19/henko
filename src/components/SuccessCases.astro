---
import arquiBrokersRounded from "../assets/arqui-brokers-rounded.webp";
import castellsInmueblesRound from "../assets/castells-inmuebles-round.webp";
import seguraSatelitalRounded from "../assets/segura-satelital-rounded.webp";
import globalCargoRounded from "../assets/global-cargo-rounded.webp";
import fideciuRounded from "../assets/fideciu-rounded.webp";

const cases = [
    {
        id: 1,
        name: "ARQUIBROKERS",
        description: "Estrategia de adquisición basada en datos escalables que incrementó un 120% la generación de leads en el sector inmobiliario.",
        circleColor: "#00205B",
        gradient: null,
        image: arquiBrokersRounded,
    },
    {
        id: 2,
        name: "CASTELLS",
        description: "Estrategia de performance orientada a escalar que impulsó la participación en subastas online, fortaleció la adopción de la app y mejoró el ROI digital.",
        circleColor: null,
        gradient: "linear-gradient(180deg, #2B5C96 0%, #183052 100%)",
        image: castellsInmueblesRound,
    },
    {
        id: 1,
        name: "SEGURA SATELITAL",
        description: "Estrategia de adquisición basada en datos que escaló la generación de leads, mejoró el ROI y acompañó el crecimiento del negocio en canales digitales.",
        circleColor: "#00205B",
        gradient: null,
        image: seguraSatelitalRounded,
    },
    {
        id: 1,
        name: "GLOBAL CARGO",
        description: "Estrategia de performance orientada a la aceleración del crecimiento regional, logrando +70% en oportunidades comerciales, expansión de demanda en nuevos mercados y una mejora sostenida del ROI digital.",
        circleColor: "#00205B",
        gradient: null,
        image: globalCargoRounded,
    },
    {
        id: 1,
        name: "FIDECIU",
        description: "Atribución avanzada, optimización por eventos para acelerar expansión de mercado y crecimiento anual con performance marketing.",
        circleColor: "#00205B",
        gradient: null,
        image: fideciuRounded,
    },
];
---

<section class="py-12 md:py-20 md:py-24 relative overflow-hidden" id="casos">
    <!-- Círculos concéntricos tipo radar (visible en mobile ajustados) -->
    <div
        class="absolute top-[-30px] md:top-[-50px] left-0 w-full h-full min-h-[420px] md:min-h-[800px] pointer-events-none"
        style="z-index: -10;"
    >
        <svg
            viewBox="0 0 1440 800"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
            class="w-full h-full"
            preserveAspectRatio="xMidYMid slice"
        >
            <circle
                cx="350"
                cy="510"
                r="300"
                stroke="#759EBC"
                stroke-width=".6"
                opacity="0.4"></circle>
            <circle
                cx="350"
                cy="510"
                r="380"
                stroke="#759EBC"
                stroke-width=".6"
                opacity="0.4"></circle>
            <circle
                cx="350"
                cy="510"
                r="460"
                stroke="#759EBC"
                stroke-width=".6"
                opacity="0.4"></circle>
        </svg>
    </div>

    <!-- Patrón de puntos en el background (solo en mobile empieza más arriba) -->
    <div
        class="absolute top-4 md:top-20 left-0 right-0 h-[280px] md:h-[450px] z-0 pointer-events-none casos-dots"
        style="z-index: 1;"
    >
    </div>
    <style>
        .casos-dots {
            background-image: radial-gradient(#CBD5E1 2.5px, transparent 2px);
            background-size: 22px 22px;
            opacity: 0.5;
        }
        @media (min-width: 768px) {
            .casos-dots {
                background-image: radial-gradient(#CBD5E1 3px, transparent 2px);
                background-size: 30px 30px;
                opacity: 0.55;
            }
        }
    </style>

    <div class="mx-auto relative z-10">
        <div class="container mx-auto px-6 md:px-8 mb-12 md:mb-20">
            <h2
                class="text-3xl md:text-5xl font-extrabold text-[#0F172A] tracking-tight mb-3 md:mb-4 max-w-4xl"
            >
                Casos de éxito
            </h2>
            <div class="space-y-4 text-gray-600 text-base md:text-lg leading-relaxed">
                <p>
                    Resultados que hablan por sí solos
                </p>
            </div>
        </div>

        <div class="relative pt-6 md:pt-10 overflow-hidden group">
            <div
                id="infiniteCarousel"
                class="flex gap-6 md:gap-8 overflow-x-hidden pb-10 md:pb-16 no-scrollbar px-4 cursor-grab active:cursor-grabbing"
            >
                {
                    cases.map((item) => (
                        <div class="carousel-item flex-none flex flex-col">
                            <div class="relative w-[260px] sm:w-[320px] md:w-[400px] mt-16 md:mt-24 hover:-translate-y-2 transition-transform duration-300 flex-1 flex flex-col">
                                <div
                                    class="absolute top-0 left-1/2 -translate-x-1/2 -translate-y-1/2 w-32 h-32 md:w-48 md:h-48 rounded-full flex items-center justify-center text-white font-bold text-xl shadow-xl z-20 overflow-hidden bg-white"
                                    style={
                                        !item.image
                                            ? `background:${item.gradient ?? item.circleColor ?? "#0B3B91"};`
                                            : ""
                                    }
                                >
                                    {(item as any).image ? (
                                        <img
                                            src={(item as any).image.src}
                                            alt={item.name}
                                            class="w-full h-full object-cover"
                                        />
                                    ) : (
                                        <span class="px-4 text-left">
                                            {(item as any).name}
                                        </span>
                                    )}
                                </div>

                                <div class="bg-white shadow-[0_8px_30px_rgb(0,0,0,0.04)] p-7 md:p-8 pt-18 md:pt-28 pb-8 text-center md:text-left border border-slate-50 flex-1 flex flex-col relative z-10" style="border-radius: 30px 100px 30px 30px;">
                                    <h3 class="text-2xl font-extrabold text-[#0F172A] uppercase tracking-wide mb-4 md:mb-6 text-center md:text-left">
                                        {item.name}
                                    </h3>

                                    <div class="flex flex-col md:flex-row items-center md:items-center justify-between gap-6 flex-grow">
                                        <div class="flex-1 text-center md:text-left">
                                            <p class="text-slate-700 text-sm font-normal leading-relaxed">
                                                {item.description}
                                            </p>
                                        </div>

                                        <div class="mt-0 md:mt-0 md:flex-shrink-0">
                                            <a
                                                href="#"
                                                class="w-12 h-12 rounded-full bg-[#0B1C3E] text-white flex items-center justify-center hover:bg-[#083763] transition-colors shadow-lg mx-auto md:mx-0"
                                            >
                                                <svg
                                                    width="20"
                                                    height="20"
                                                    viewBox="0 0 24 24"
                                                    fill="none"
                                                    xmlns="http://www.w3.org/2000/svg"
                                                >
                                                    <path
                                                        d="M5 12H19M19 12L12 5M19 12L12 19"
                                                        stroke="currentColor"
                                                        stroke-width="2"
                                                        stroke-linecap="round"
                                                        stroke-linejoin="round"
                                                    />
                                                </svg>
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    ))
                }
            </div>
        </div>
    </div>
</section>

<script>
    import { gsap } from "gsap";

    function initInfiniteCarousel() {
        const carouselEl = document.getElementById(
            "infiniteCarousel",
        ) as HTMLElement | null;
        if (!carouselEl) return;
        const carousel = carouselEl as HTMLElement;

        // Configuración
        const SPEED = 0.5; // Velocidad del autoscroll (píxeles por frame)
        let scrollAmount = 0;
        let isHovered = false;
        let animationId;

        // 1. Duplicar contenido para efecto infinito
        const items = Array.from(
            carousel ? carousel.children : [],
        ) as HTMLElement[];
        const containerWidth = carousel.offsetWidth;
        const totalContentWidth = carousel.scrollWidth;

        items.forEach((item) => {
            const clone = (item as HTMLElement).cloneNode(true) as HTMLElement;
            clone.setAttribute("aria-hidden", "true");
            carousel.appendChild(clone);
        });

        if (totalContentWidth < containerWidth * 2) {
            items.forEach((item) => {
                const clone = (item as HTMLElement).cloneNode(
                    true,
                ) as HTMLElement;
                clone.setAttribute("aria-hidden", "true");
                carousel.appendChild(clone);
            });
        }

        // 2. Lógica de animación
        function step() {
            if (!isHovered) {
                scrollAmount += SPEED;
                const firstSetWidth = items.reduce(
                    (acc, item) => acc + (item as HTMLElement).offsetWidth + 32,
                    0,
                );

                if (scrollAmount >= firstSetWidth) {
                    scrollAmount = 0;
                }

                carousel.scrollLeft = scrollAmount;
            }
            animationId = requestAnimationFrame(step);
        }

        animationId = requestAnimationFrame(step);

        // 3. Control de Pausa e Interacción
        carousel.addEventListener("mouseenter", () => (isHovered = true));
        carousel.addEventListener("mouseleave", () => (isHovered = false));

        // Soporte básico para arrastrar (Drag to scroll)
        let isDown = false;
        let startX: number;
        let startScrollLeft: number;

        carousel.addEventListener("mousedown", (e) => {
            isDown = true;
            isHovered = true;
            carousel.style.cursor = "grabbing";
            startX = e.pageX - carousel.offsetLeft;
            startScrollLeft = scrollAmount;
        });

        carousel.addEventListener("mouseleave", () => {
            isDown = false;
            isHovered = false;
            carousel.style.cursor = "grab";
        });

        carousel.addEventListener("mouseup", () => {
            isDown = false;
            carousel.style.cursor = "grab";
        });

        carousel.addEventListener("mousemove", (e) => {
            if (!isDown) return;
            e.preventDefault();
            const x = e.pageX - carousel.offsetLeft;
            const walk = (x - startX) * 2;
            scrollAmount = startScrollLeft - walk;
            if (scrollAmount < 0) scrollAmount = 0;
            carousel.scrollLeft = scrollAmount;
        });

        // 4. 3D Tilt Effect
        const cards = document.querySelectorAll(".carousel-item > div");

        cards.forEach((card) => {
            const el = card as HTMLElement;

            el.addEventListener("mousemove", (e) => {
                if (isDown) return; // Disable tilt while dragging

                const rect = el.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;

                const centerX = rect.width / 2;
                const centerY = rect.height / 2;

                const rotateX = ((y - centerY) / centerY) * -5; // Max rotation deg
                const rotateY = ((x - centerX) / centerX) * 5;

                gsap.to(el, {
                    rotationX: rotateX,
                    rotationY: rotateY,
                    scale: 1.02,
                    duration: 0.4,
                    ease: "power2.out",
                    transformPerspective: 1000,
                    transformOrigin: "center",
                });
            });

            el.addEventListener("mouseleave", () => {
                gsap.to(el, {
                    rotationX: 0,
                    rotationY: 0,
                    scale: 1,
                    duration: 0.7,
                    ease: "elastic.out(1, 0.5)",
                });
            });
        });
    }

    if (typeof window !== "undefined") {
        document.addEventListener("DOMContentLoaded", initInfiniteCarousel);
    }
</script>

<style>
    /* Utilidad para ocultar scrollbar */
    .no-scrollbar::-webkit-scrollbar {
        display: none;
    }
    .no-scrollbar {
        -ms-overflow-style: none;
        scrollbar-width: none;
    }

    /* Opcional: Desvanecimiento en los bordes para mejorar el efecto infinito */
    /* .mask-gradient {
        mask-image: linear-gradient(to right, transparent, black 5%, black 95%, transparent);
    } */
</style>
